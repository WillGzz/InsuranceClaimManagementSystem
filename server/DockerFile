# ---- Build backend (Spring Boot) ----
FROM eclipse-temurin:17-jdk AS backend-builder
WORKDIR /app

# Copy Maven wrapper & config
COPY mvnw .
COPY .mvn .mvn
COPY pom.xml .
RUN chmod +x mvnw
RUN ./mvnw dependency:go-offline

# Copy backend source
COPY src src

# Build the Spring Boot jar (skip tests for speed)
RUN ./mvnw clean package -DskipTests


# ---- Build frontend (Angular) ----
FROM node:18 AS frontend-builder
WORKDIR /app

# Copy Angular client code
COPY client/ ./client/
WORKDIR /app/client

# Install dependencies & build Angular app for production
RUN npm install
RUN npm run build --configuration production


# ---- Runtime image ----
FROM eclipse-temurin:17-jdk
WORKDIR /app

# Copy backend JAR
COPY --from=backend-builder /app/target/claims-0.0.1-SNAPSHOT.jar app.jar

# Copy Angular build into Spring Boot static resources
# Your Angular build path: client/dist/client/browser
COPY --from=frontend-builder /app/client/dist/client/browser/ /app/static/

# Expose port
EXPOSE 8080

# Start the Spring Boot app
ENTRYPOINT ["java", "-jar", "app.jar"]
